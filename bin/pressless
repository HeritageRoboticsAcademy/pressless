#!/usr/bin/env node
'use strict';

const asciify = require('asciify');
const async = require('async');
const aws = require('aws-sdk');
const DSNParser = require('dsn-parser');
const exec = require('child_process').exec;
const fs = require('fs');
const fse = require('fs-extra');
const fstream = require('fstream');
const MysqlTools = require('mysql-tools');
const os = require('os');
const path = require('path');
const program = require('commander');
const request = require('request');
const shell = require('shelljs');
const tarball = require('tarball-extract');
const tld = require('tldjs');
const unzip = require('unzip');

const ServerlessCustomDomain = require(path.resolve(path.dirname(__dirname),'./lib/serverless-domain-manager'));

function getDomain() {
    const serverlessYml = fs.readFileSync('.pressless/serverless.yml');
    var matches = serverlessYml.toString().match(/domainName: (.*?)\n/);
    if (matches && matches[1]) {
        return matches[1];
    } else {
        console.log('Pressless: Unable to determine primary domain for project.');
        process.exit(1);
    }
}

function getWebsiteBucket() {
    const serverlessYml = fs.readFileSync('.pressless/serverless.yml');
    var matches = serverlessYml.toString().match(/websiteBucket: (.*?)\n/);
    if (matches && matches[1]) {
        return matches[1];
    } else {
        console.log('Pressless: Unable to determine website bucket for project.');
        process.exit(1);
    }
}

function getLoggingBucket() {
    const serverlessYml = fs.readFileSync('.pressless/serverless.yml');
    var matches = serverlessYml.toString().match(/loggingBucket: (.*?)\n/);
    if (matches && matches[1]) {
        return matches[1];
    } else {
        console.log('Pressless: Unable to determine logging bucket for project.');
        process.exit(1);
    }
}

program
  .command('setup <domain> <website_bucket>')
  .description('Setup pressless configuration and install dependencies')
  .option("-c, --certificate <certificate>", "AWS ACM certificate name to use")
  .action(function(domain, website_bucket, options) {
    // look for wp-config.php
    if (!fs.existsSync('wp-config.php')) {
        return console.log('Pressless: Unable to find a valid Wordpress installation.  Please run pressless inside your Wordpress directory.');
    }
 
    if (domain.toLowerCase() == website_bucket.toLowerCase()) {
        return console.log('Pressless: <domain> and <website_bucket> must be different.');
    }
 
    if (!tld.isValid(domain.toLowerCase())) {
        return console.log('Pressless: ' + domain + ' is not a valid domain.');
    }

    if (!tld.isValid(website_bucket.toLowerCase())) {
        return console.log('Pressless: ' + website_bucket + ' is not a valid domain.');
    }

    if (!tld.isValid(options.certificate)) {
        return console.log('Pressless: ' + options.certificate + ' is not a valid certificate name.');
    }

    domain = tld.getSubdomain(domain.toLowerCase()) + tld.getDomain(domain.toLowerCase());
    website_bucket = tld.getSubdomain(website_bucket.toLowerCase()) + tld.getDomain(website_bucket.toLowerCase());
    const name = domain.replace(/[\.\_\']/g, '-').substring(0, domain.length - (options.env||'dev').length - (options.region||'us-east-1').length - '---lambdaRole'.length);  // created iam role must be <= 64 chars
    const loggingBucket = website_bucket + '-logs';

    const dotenv = `PRESSLESS_DOMAIN=${domain}
PRESSLESS_S3_WEBSITE_BUCKET=${website_bucket}
PRESSLESS_S3_LOGGING_BUCKET=${loggingBucket}`;

    const packageJson = `{
  "name": "${name}",
  "dependencies": {
    "binary-case": "^1.1.3",
    "dotenv": "^4.0.0",
    "serverless": "^1.0.0",
    "serverless-domain-manager": "^1.1.0"
  }
}`;

    const serverlessYml = `service: ${name}
provider:
  name: aws
  runtime: nodejs6.10
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 's3:ListBucket'
      Resource:
        Fn::Join:
          - ''
          - - 'arn:aws:s3:::'
            - Ref: ServerlessDeploymentBucket
    - Effect: 'Allow'
      Action:
        - 's3:CreateBucket'
      Resource:
        - 'arn:aws:s3:::*'
    - Effect: 'Allow'
      Action:
        - 's3:*'
      Resource:
        - 'arn:aws:s3:::${loggingBucket}'
        - 'arn:aws:s3:::${loggingBucket}/*'
        - 'arn:aws:s3:::${website_bucket}'
        - 'arn:aws:s3:::${website_bucket}/*'

package:
  exclude:
    - '*'
    - '**'
  include:
    - .env
    - handler.js
    - handler.php
    - aws.phar
    - node_modules/binary-case/**
    - node_modules/dotenv/**
    - php
    - wordpress/**
    - Evolution.php
    - lib/**
    - vendor/**
    - web/**

plugins:
  - serverless-domain-manager

custom:
  pressless:
    loggingBucket: ${loggingBucket}
    websiteBucket: ${website_bucket}
  customDomain:
    basePath:
    domainName: ${domain}
    stage: dev
    certificateName: '${options.certificate}'

functions:
  ${name}:
    handler: handler.handle
    cors: true
    events:
      - http: ANY /
      - http: ANY {proxy+}
    timeout: 300`;

    // check for existance of ACM certificate, otherwise request one
    const slsDomainManager = new ServerlessCustomDomain({service: {custom: {customDomain: {domainName: domain, certificateName: options.certificate}}}});
    try {
        slsDomainManager.getCertArn()
    } catch (e) {
        console.log('Pressless: certificate ' + options.certificate + ' does not exist, requesting...');

        var params = {
            DomainName: options.certificate,
            DomainValidationOptions: [
                {
                DomainName: options.certificate,
                ValidationDomain: tld.getDomain(options.certificate)
                }
            ],
            IdempotencyToken: options.certificate,

        };
        new aws.ACM({region: 'us-east-1'}).requestCertificate(params, function(err, data) {
            if (err) console.log('Pressless: Error requesting certificate for ' + options.certificate + ': ', err);
            else console.log('Pressless: a validation email has been sent to the administrators of ' + tld.getDomain(options.certificate) + ' for approval.  Once approved, the certificate will be issued.');
        });
    }

    fse.mkdirsSync('.pressless');
    fs.writeFileSync('.pressless/.env', dotenv);
    fs.writeFileSync('.pressless/package.json', packageJson);
    fs.writeFileSync('.pressless/serverless.yml', serverlessYml);

    shell.cd('.pressless');
    var npmInstall = shell.exec('npm install', {silent: true}).stdout;
    fse.copySync(path.resolve(path.dirname(__dirname),'./lib/serverless-domain-manager.js'), 'node_modules/serverless-domain-manager/index.js');
    console.log('Pressless: Setup complete.');
}); 

program
  .command('domain')
  .description('Create AWS ApiGateway custom domain')
  .action(function(options) {
    if (!fs.existsSync('.pressless/serverless.yml')) {
        return console.log('Pressless: You must first call "pressless setup".');
    }
   
    shell.cd('.pressless');
    shell.exec('node_modules/.bin/serverless create_domain'); 
}); 

program
  .command('copydb <dsn>')
  .description('Copy database')
  .action(function(dsn, options) {
    if (!fs.existsSync('.pressless/serverless.yml')) {
        return console.log('Pressless: You must first call "pressless setup".');
    }

    var dsn = new DSNParser(dsn);

    const domain = getDomain();

    var fromDatabase = {};
    const wpConfig = fs.readFileSync('wp-config.php');
    var matches = wpConfig.toString().match(/define\('DB_NAME', '(.*?)'/);
    if (matches && matches[1]) { fromDatabase.database = matches[1]; }
    var matches = wpConfig.toString().match(/define\('DB_USER', '(.*?)'/);
    if (matches && matches[1]) { fromDatabase.user = matches[1]; }
    var matches = wpConfig.toString().match(/define\('DB_PASSWORD', '(.*?)'/);
    if (matches && matches[1]) { fromDatabase.password = matches[1]; }
    var matches = wpConfig.toString().match(/define\('DB_HOST', '(.*?)'/);
    if (matches && matches[1]) { fromDatabase.host = matches[1]; }
    
    // create database dump sql file
    var tool = new MysqlTools();
    var dumpSqlFileName = os.tmpdir() + '/' + domain + new Date().getTime() + '.sql';
    tool.dumpDatabase({
        host: fromDatabase.host
        , user: fromDatabase.user
        , password: fromDatabase.password
        , dumpPath: dumpSqlFileName
        , database: fromDatabase.database
    }, function (error, output, message, dumpFileName) {
        if (error instanceof Error) {
            console.log(error);
        } else {
            // restore dump sql file to database
            var tool = new MysqlTools();
            tool.restoreDatabase({
                host: dsn.get('host')
                , user: dsn.get('user')
                , password: dsn.get('password')
                , sqlFilePath: dumpSqlFileName
                , database: dsn.get('database')
            }, function (error, output, message) {
                if (error instanceof Error) {
                    console.log(error);
                } else {
                    console.log(output);
                    console.log(message);

                    // fix wp-config entries
                }
            });
        }
    });
}); 

program
  .command('deploy')
  .description('Deploy Wordpress via Serverless')
  .option("-e, --env <env>", "Environment to use")
  .option("-r, --region <region>", "Region to use")
  .option("-v, --verbose", "Show events as they occur")
  .action(function(options) {
    if (!fs.existsSync('.pressless/serverless.yml')) {
        return console.log('Pressless: You must first call "pressless setup".');
    }

    const domain = getDomain();
    const websiteBucket = getWebsiteBucket();
    const loggingBucket = getLoggingBucket();
    const pwd = shell.pwd().toString();
 
    // support for Evolution (https://github.com/evolution/wordpress)
    const wpConfig = fs.readFileSync('wp-config.php').toString();
    const isEvolution = (wpConfig.indexOf('Evolution.php') > 0 && fs.existsSync('../Evolution.php')) ? true : false;    
 
    try { fs.unlinkSync(os.tmpdir() + '/wordpress_latest.tar.gz'); } catch (e) {}
    console.log('Pressless: Downloading latest Wordpress release to ' + os.tmpdir() + '...');
    tarball.extractTarballDownload('https://wordpress.org/latest.tar.gz', os.tmpdir() + '/wordpress_latest.tar.gz', '.pressless', {}, function(err, result) {
        if (err) {
            console.log(err, result); 
            return;
        }

        // remove archive
        fs.unlinkSync(os.tmpdir() + '/wordpress_latest.tar.gz');

        // copy files into .pressless
        fse.copySync(path.resolve(path.dirname(__dirname),'./src/handler.js'), '.pressless/handler.js');
        fse.copySync(path.resolve(path.dirname(__dirname),'./src/handler.php'), '.pressless/handler.php');
        fse.copySync(path.resolve(path.dirname(__dirname),'./lib/aws.phar'), '.pressless/aws.phar');
        fse.copySync(path.resolve(path.dirname(__dirname),'./bin/php'), '.pressless/php');
                                                                               
        console.log('Pressless: Importing existing Wordpress site...');

        // support for Evolution (https://github.com/evolution/wordpress)
        if (isEvolution) {
            console.log('Pressless: Detected Evolution, including...');

            fse.copySync('../Evolution.php', '.pressless/Evolution.php');    
            if (fs.existsSync('../lib/ansible/group_vars/all')) {
                fse.mkdirsSync('.pressless/lib/ansible/group_vars');
                fse.copySync('../lib/ansible/group_vars/all', '.pressless/lib/ansible/group_vars/all');    
            }

            if (fs.existsSync('../composer.json') && !fs.existsSync('../vendor')) {
                console.log('Pressless: composer.json found, installing missing dependencies...');
                if (shell.which('php')) {
                    shell.cd('..');
                    shell.exec('php -r "echo file_get_contents(\'https://raw.githubusercontent.com/composer/getcomposer.org/master/web/installer\');" | php -- --quiet && php composer.phar install && rm composer.phar');
                    shell.cd(pwd);
                } else {
                    return console.log('Pressless: Unable to install composer dependencies, `php` binary not found');
                }
            }

            if (fs.existsSync('../vendor')) {
                fse.copySync('../vendor/', '.pressless/vendor');
            }

            // rename wordpress directory down into wp
            fse.moveSync('.pressless/wordpress', '.pressless/wp')
            fse.mkdirsSync('.pressless/wordpress');
            fse.moveSync('.pressless/wp', '.pressless/wordpress/wp')

            // copy all files, since we may need more for an Evolution site
            fse.copySync('./', '.pressless/wordpress/', {filter: (src, dest) => {
                // don't cyclical copy, etc
                return (src.indexOf('.pressless') >= 0 || src.indexOf('.htaccess') >= 0) ? false : true;
            }});
        } else {
            fse.copySync('index.php', '.pressless/wordpress/index.php');
            fse.copySync('wp-config.php', '.pressless/wordpress/wp-config.php');
            fse.copySync('wp-content', '.pressless/wordpress/wp-content');

            fse.copySync('./', '.pressless/wordpress/', {filter: (src, dest) => {
                // don't cyclical copy, etc
                return (src.indexOf('.pressless') >= 0 || src.indexOf('.htaccess') >= 0 || src.indexOf('wp-') === 0 || src.indexOf('.php') > 0) ? false : true;
            }});  
        }

        async.parallel([
            function(callback) {
                console.log('Pressless: Installing Jetpack plugin...');
                //fs.mkdirSync(path.join(pwd, '.pressless/wordpress/wp-content/plugins/jetpack'));
                var zipFilePath = path.join(pwd, '.pressless/wordpress/wp-content/plugins', 'jetpack.5.0.zip');
                request('https://downloads.wordpress.org/plugin/jetpack.5.0.zip')
                    .on('error', function (err) {
                        console.log('Pressless: requestZip: ', err);
                    })
                    .pipe(fs.createWriteStream(zipFilePath))
                    .on('error', function (err) {
                        console.log('Pressless: createZip: ', err);
                    })
                    .on('finish', function () {
                        var readStream = fs.createReadStream(zipFilePath),
                            writeStream = fstream.Writer(path.join(pwd, '.pressless/wordpress/wp-content/plugins'));

                        readStream
                            .pipe(unzip.Parse())
                            .on('error', function (err) {
                                console.log('Pressless: parseZip: ', err);
                            })
                            .pipe(writeStream)
                            .on('error', function (err) {
                                console.log('Pressless: unZip: ', err);
                            })
                            .on('close', function () {
                                fs.unlinkSync(zipFilePath);
                                callback(null);
                            });
                    });
            }
        ],
        // optional callback
        function(err, results) {
            if (err) {
                console.log('Pressless: erroring installing plugins: ' + err);
                // cleanup copied files
                try { fse.removeSync('lib'); } catch (e) {}
                try { fse.removeSync('vendor'); } catch (e) {}
                try { fse.removeSync('web'); } catch (e) {}
                try { fse.removeSync('wordpress'); } catch (e) {}
                try { fs.unlinkSync('Evolution.php'); } catch (e) {}
                return;
            }

            if (isEvolution) fse.moveSync('.pressless/wordpress', '.pressless/web');

            shell.cd('.pressless');
            var child = shell.exec('SLS_ENV=' + (options.env?options.env:'dev') + ' node_modules/.bin/serverless deploy'
                + (options.env?' --stage '+options.env:'')
                + (options.region?' --region '+options.region:'')
                + (options.verbose?' --verbose:':''), {async:true});
            child.stdout.on('finish', function(data) {
                console.log("\nPressless: You can now visit your new Pressless site at:");
                console.log("https://" + domain);

                // cleanup copied files
                try { fse.removeSync('lib'); } catch (e) {}
                try { fse.removeSync('vendor'); } catch (e) {}
                try { fse.removeSync('web'); } catch (e) {}
                try { fse.removeSync('wordpress'); } catch (e) {}
                try { fs.unlinkSync('Evolution.php'); } catch (e) {}
            });
        });
    });
}); 

program
  .command('test <stage> <request_path>')
  .description('Test the Serverless function')
  .action(function(stage, requestPath, options) {
    if (!fs.existsSync('.pressless/serverless.yml')) {
        return console.log('Pressless: You must first call "pressless setup".');
    }
 
    const domain = getDomain();
    const functionName = domain.replace(/[\.\_\']/g, '-');
    const eventData = '{"path":"' + requestPath + '","httpMethod":"GET","headers":{"Host":"' + domain + '"},"queryStringParameters":null}';
    const localMode = stage == 'local' ? stage : '';

    shell.cd('.pressless');
    shell.exec('node_modules/.bin/serverless invoke ' + localMode + ' -f ' + functionName + ' -d ' + eventData);
}); 

asciify('pressless', {font: 'larry3d', maxWidth: 75}, function (err, result) {
    result = result.toString().replace('                                                                 ', "                ---helping wordpress cost less---");
    console.log(result);
    if (process.argv.length == 2) program.outputHelp(); 
    program.parse(process.argv);
});
